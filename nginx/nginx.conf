worker_processes  1;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections  1024;
}

http {
    lua_shared_dict rate_limit_store 10m;
    lua_shared_dict challenge_sessions 10m;
    lua_shared_dict banned_ips 1m;
    lua_shared_dict ip_list_store 10m;

    lua_package_path "/usr/local/openresty/lualib/?.lua;;" ;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for" '
                     '"$request_time" "$upstream_response_time"';
    
    log_format denied '$remote_addr - [$time_local] "$request" $status '
                      '"$http_user_agent" "$http_referer"';

    limit_req_zone $binary_remote_addr zone=perip:10m rate=5r/m;
    
    init_by_lua_block {
        local ok, waf = pcall(require, "waf")
        if not ok then
            ngx.log(ngx.ERR, "Failed to load waf module: ".. waf)
        end
    }

    server {
        listen 80;
        server_name flexiwaf.local;
        
        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        location / {
            access_by_lua_block {
                local ok, waf = pcall(require, "waf")
                if ok and waf and waf.apply_rules then
                    waf.apply_rules()
                else
                    ngx.log(ngx.ERR, "waf.apply_rules not available in access_by_lua_block")
                end
            }

            default_type text/html;
            content_by_lua_block {
                ngx.say("<h1>Welcome to FlexiWAF Protected Server</h1>")
                ngx.say("<p>This is a test page to confirm your server is running.</p>")
                ngx.say("<p>Any attempts to exceed the rate limit or trigger WAF rules will be blocked or challenged.</p>")
            }
        }
        
        location /challenge {
            access_by_lua_block {
                local ok, waf = pcall(require, "waf")
                if ok and waf and waf.handle_challenge then
                    waf.handle_challenge()
                else
                    ngx.log(ngx.ERR, "waf.handle_challenge not available")
                    ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
                end
            }
        }
        
        location /admin {
            access_log /var/log/nginx/honeypot_access.log denied;
            content_by_lua_block {
                ngx.log(ngx.WARN, "WAF: Honeypot access attempt from: ".. ngx.var.remote_addr.. " Request: ".. ngx.var.request_uri)
                ngx.exit(ngx.HTTP_NOT_FOUND)
            }
        }

        location /update_rules {
            internal; # يضمن أن هذا الموقع يمكن الوصول إليه فقط من داخل الشبكة
            content_by_lua_block {
                local ok, waf = pcall(require, "waf")
                local body = ngx.req.get_body_data()
                if body then
                    waf.update_rules(ngx.req.get_headers(), body)
                    ngx.say("Rules updated successfully.")
                else
                    ngx.say("No body provided.")
                end
            }
        }
    }
}