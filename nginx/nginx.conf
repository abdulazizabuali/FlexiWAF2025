# التعديل: استخدم auto للاستفادة القصوى من موارد المعالج
worker_processes  auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections  1024;
}

http {
    # 1. تعريف الذاكرات المشتركة لـ Lua
    lua_shared_dict rate_limit_store 10m;
    lua_shared_dict challenge_sessions 10m;
    lua_shared_dict ip_list_store 10m;
    
    # ✅ نظام map محسن للوغز (للسماح بالتسجيل الشرطي)
    map $waf_log_type $log_standard {
        default 0;
        "NONE" 1;
    }

    map $waf_log_type $log_rate_limit {
        default 0;
        "RATE_LIMIT" 1;
    }
    
    map $waf_log_type $log_temp_ban {
        default 0;
        "TEMP_BAN" 1;
    }
    
    map $waf_log_type $log_blocked_ip {
        default 0;
        "BLOCKED_IP" 1;
    }
    
    map $waf_log_type $log_captcha_fail {
        default 0;
        "CAPTCHA_FAIL" 1;
    }
    
    map $waf_log_type $log_captcha_success {
        default 0;
        "CAPTCHA_SUCCESS" 1;
    }
    
    map $waf_log_type $log_grace_period {
        default 0;
        "GRACE_PERIOD" 1;
    }

    # ✅ (1) التعديل: تعريف تنسيق سجل الدخول الموحد للـ WAF (waf_log)
    # هذا التنسيق يشمل جميع المتغيرات اللازمة للتحليل في ملف واحد.
    log_format waf_log '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'waf_type=$waf_log_type '
                       'uri=$request_uri '
                       'failed_attempts=$captcha_attempts '
                       'ban_duration=$ban_duration '
                       'ban_reason=$ban_reason';

    # تنسيق السجل الرئيسي القياسي
    log_format main '$remote_addr - [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"';
    
    # تنسيق سجل الهوني بوت
    log_format honeypot '$remote_addr - [$time_local] "HONEYPOT" Path: "$request_uri" "$http_user_agent"';

    lua_package_path "/etc/nginx/?.lua;;/usr/local/openresty/lualib/?.lua;;";

    init_by_lua_block {
        local ok, waf = pcall(require, "waf")
        if not ok then
            ngx.log(ngx.ERR, "Failed to load waf module: ".. waf)
        end
        
        if ok and waf then
            _G.waf_module = waf
            waf.load_configurations()
        end
    }
    
    server { 
        listen 80;
        server_name flexiwaf.local;
        
        error_log /var/log/nginx/error.log warn;
        
        # ✅ إعادة تعيين متغيرات اللوغز في كل طلب
        set $waf_log_type "NONE";
        set $captcha_attempts "0";
        set $ban_duration "0";
        set $ban_reason "NONE";

        # ✅ مسارات الهوني بوت المحسنة
        location ~ ^/(admin|wp-admin|phpmyadmin|backup|config|debug|test|console|\.env|\.git|api/v1/secret)$ {
            access_log /var/log/nginx/honeypot_access.log honeypot;
            
            content_by_lua_block {
                local path = ngx.var.request_uri
                ngx.log(ngx.WARN, "WAF: HONEYPOT_TRIGGERED - Access attempt to ".. path.. " from IP: ".. ngx.var.remote_addr)
                ngx.exit(ngx.HTTP_NOT_FOUND)
            }
        }
        
        location / {
            # ✅ (2) التعديل: توحيد جميع سجلات WAF إلى ملف واحد (waf_events.log) باستخدام التنسيق الموحد (waf_log)
            access_log /var/log/nginx/waf_events.log waf_log if=$log_rate_limit;
            access_log /var/log/nginx/waf_events.log waf_log if=$log_temp_ban;
            access_log /var/log/nginx/waf_events.log waf_log if=$log_blocked_ip;
            access_log /var/log/nginx/waf_events.log waf_log if=$log_captcha_fail;
            access_log /var/log/nginx/waf_events.log waf_log if=$log_captcha_success;
            access_log /var/log/nginx/waf_events.log waf_log if=$log_grace_period;
            
            # ✅ السجل الرئيسي للطلبات العادية فقط
            access_log /var/log/nginx/access.log main if=$log_standard; 

            access_by_lua_block {
                local waf = _G.waf_module
                if waf and waf.apply_rules then
                    waf.apply_rules()
                else
                    ngx.log(ngx.ERR, "waf.apply_rules not available")
                end
            }
            
            default_type text/html;
            content_by_lua_block {
                ngx.say("<h1>Welcome to FlexiWAF Protected Server</h1>")
                ngx.say("<p>This is a test page to confirm your server is running.</p>")
                ngx.say("<p>Any attempts to exceed the rate limit or trigger WAF rules will be blocked or challenged.</p>")
                ngx.say("<p>Current time: " .. os.date("%Y-%m-%d %H:%M:%S") .. "</p>")
            }
        }
        
        location /challenge {
            # ✅ التعديل: إزالة سجلات الدخول الخاصة بـ CAPTCHA من هنا والاعتماد على السجلات الشرطية الموحدة في location /
            
            content_by_lua_block {
                ngx.req.read_body()
                local waf = _G.waf_module
                if waf and waf.handle_challenge then
                    waf.handle_challenge()
                else
                    ngx.log(ngx.ERR, "waf.handle_challenge not available")
                    ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
                end
            }
        }
        
        location /update_rules {
            internal;
            content_by_lua_block {
                local waf = _G.waf_module
                if not waf or not waf.update_rules then
                    ngx.say("WAF module not loaded.")
                    return
                end
                local args = ngx.req.get_uri_args()
                local file_type = args.type
                ngx.req.read_body()
                local content = ngx.req.get_body_data()
                if content and file_type then
                    local result = waf.update_rules(file_type, content)
                    ngx.say(result)
                else
                    ngx.say("Error: Missing 'type' parameter or request body.")
                end
            }
        }
        
        # API للحصول على حالة النظام
        location /waf_status {
            internal;
            content_by_lua_block {
                local waf = _G.waf_module
                if not waf then
                    ngx.say("WAF module not loaded")
                    return
                end
                
                local status = {
                    rate_limit_config = ngx.shared.rate_limit_store:get("config"),
                    ip_list_config = ngx.shared.ip_list_store:get("config"),
                    active_sessions = 0,
                    banned_ips = 0,
                    current_log_type = ngx.var.waf_log_type or "NONE"
                }
                
                -- حساب عدد الجلسات النشطة
                local sessions_count = 0
                local session_keys = ngx.shared.challenge_sessions:get_keys(100)
                for _, key in ipairs(session_keys) do
                    if key:find("sess_") then
                        sessions_count = sessions_count + 1
                    end
                end
                status.active_sessions = sessions_count
                
                -- حساب عدد الأيبيات المحظورة
                local banned_count = 0
                local banned_keys = ngx.shared.rate_limit_store:get_keys(100)
                for _, key in ipairs(banned_keys) do
                    if key:find("banned_ip_") then
                        banned_count = banned_count + 1
                    end
                end
                status.banned_ips = banned_count
                
                ngx.header.content_type = "application/json"
                ngx.say(require("cjson").encode(status))
            }
        }
        
        # ✅ مسار للتحقق من صحة النظام
        location /health {
            access_log off;
            content_by_lua_block {
                ngx.header.content_type = "application/json"
                ngx.say('{"status": "healthy", "timestamp": "' .. os.date("%Y-%m-%d %H:%M:%S") .. '", "waf_loaded": ' .. tostring(_G.waf_module ~= nil) .. '}')
            }
        }
    }
}
